(alias (name default) (deps Parser.bc.js))

(executables
 (names Parser)
 (libraries
    semgrep_js_shared
    parser_go.menhir
    parser_go.tree_sitter
    parser_go.ast_generic
 )
 (modes js)
  (js_of_ocaml
  (javascript_files semgrep.js)
  (flags --pretty --no-inline)
  )
 (preprocess
  (pps js_of_ocaml-ppx))
)

(rule
 (targets semgrep-go-parser.js semgrep-go-parser.wasm)
 (deps
  ../../../libs/ocaml-tree-sitter-core/downloads/tree-sitter-0.20.6/lib/src/lib.c
  ../../../languages/go/tree-sitter/semgrep-go/lib/parser.c)
 (action
  (run
   emcc
   -O3
   -I../../../libs/ocaml-tree-sitter-core/downloads/tree-sitter-0.20.6/lib/src
   -I%{env:TREESITTER_INCDIR=/usr/local/include}
   %{deps}
   -o
   semgrep-go-parser.js
   -sALLOW_MEMORY_GROWTH=1
   -sEXPORTED_RUNTIME_METHODS=%{read:../../shared/exported-runtime-methods.txt}
   -sEXPORTED_FUNCTIONS=_tree_sitter_go,%{read:../../shared/exported-functions.txt}
   -sMODULARIZE
   )))

(rule
  (target entrypoint.js)
  (deps ../../shared/entrypoint.js)
  (action (copy %{deps} %{target}))
)

(rule
  (target webworker.js)
  (deps ../../shared/webworker.js)
  (action (copy %{deps} %{target}))
)

(rule
  (target semgrep-parser.js)
  (deps semgrep-go-parser.js)
  (action (copy %{deps} %{target}))
)

(rule
 (alias javascript)
 (target semgrep-go.js)
 (deps entrypoint.js semgrep-parser.js Parser.bc.js)
 (action
  (run esbuild entrypoint.js --bundle --minify --platform=neutral --log-override:duplicate-case=silent --external:path --external:fs --external:constants --external:tty --external:child_process --outfile=%{target})))

(rule
 (alias javascript)
 (target semgrep-go-webworker.js)
 (deps webworker.js semgrep-parser.js Parser.bc.js)
 (action
  (run esbuild webworker.js --bundle --minify --log-override:duplicate-case=silent --external:path --external:fs --external:constants --external:tty --external:child_process --outfile=%{target})))
